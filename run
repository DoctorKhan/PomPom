#!/bin/bash

# PomPom App Runner
echo "ðŸ• Starting PomPom App..."

if [ "$1" = "test" ]; then
    echo "ðŸ§ª Running tests with logging..."

    # Clear previous test log
    > test-results.log
    echo "ðŸ“ Test results will be logged to: test-results.log"

    if command -v node &> /dev/null; then
        echo "ðŸ“¡ Starting Node.js test server on http://localhost:8000"
        node server.js &
        SERVER_PID=$!
        sleep 3

        if command -v open &> /dev/null; then
            open "http://localhost:8000/tests/"
        else
            echo "Open http://localhost:8000/tests/ in your browser"
        fi

        echo "ðŸ“Š Monitoring test results..."
        echo "   - View live logs: tail -f test-results.log"
        echo "   - Test results are automatically saved to test-results.log"
        echo "   - Press Ctrl+C to stop the server"

        # Monitor log file in background
        if command -v tail &> /dev/null; then
            echo "ðŸ“ˆ Live test output:"
            tail -f test-results.log &
            TAIL_PID=$!
            trap "kill $SERVER_PID $TAIL_PID 2>/dev/null" EXIT
        else
            trap "kill $SERVER_PID 2>/dev/null" EXIT
        fi

        wait $SERVER_PID
    else
        echo "Node.js not found. Please install Node.js to run tests with logging."
        echo "Falling back to simple HTTP server..."
        if command -v python3 &> /dev/null; then
            echo "ðŸ“¡ Starting simple test server on http://localhost:8001"
            python3 -m http.server 8001 &
            SERVER_PID=$!
            sleep 2

            if command -v open &> /dev/null; then
                open "http://localhost:8001/tests/"
            else
                echo "Open http://localhost:8001/tests/ in your browser"
            fi

            echo "âš ï¸  Note: Test logging requires Node.js server"
            echo "Press Ctrl+C to stop the server"
            trap "kill $SERVER_PID" EXIT
            wait $SERVER_PID
        else
            echo "Neither Node.js nor Python3 found. Opening test file directly..."
            if command -v open &> /dev/null; then
                open "tests/"
            else
                echo "Please open tests/ in your browser"
            fi
        fi
    fi
elif [ "$1" = "firebase" ]; then
    echo "ðŸ”¥ Running Firebase tests..."
    if command -v python3 &> /dev/null; then
        echo "ðŸ“¡ Starting Firebase test server on http://localhost:8002"
        python3 -m http.server 8002 &
        SERVER_PID=$!
        sleep 2

        if command -v open &> /dev/null; then
            open "http://localhost:8002/test-firebase.html"
        else
            echo "Open http://localhost:8002/test-firebase.html in your browser"
        fi

        echo "Press Ctrl+C to stop the server"
        trap "kill $SERVER_PID" EXIT
        wait $SERVER_PID
    else
        echo "Python3 not found. Opening test file directly..."
        if command -v open &> /dev/null; then
            open "test-firebase.html"
        else
            echo "Please open test-firebase.html in your browser"
        fi
    fi
else
    echo "ðŸš€ Starting PomPom App..."
    if command -v node &> /dev/null; then
        echo "ðŸ“¡ Starting Node.js server on http://localhost:8000"
        node server.js &
        SERVER_PID=$!
        sleep 2

        if command -v open &> /dev/null; then
            open "http://localhost:8000"
        else
            echo "Open http://localhost:8000 in your browser"
        fi

        echo "Press Ctrl+C to stop the server"
        trap "kill $SERVER_PID" EXIT
        wait $SERVER_PID
    else
        echo "Node.js not found. Please install Node.js to run the server."
        exit 1
    fi
fi
