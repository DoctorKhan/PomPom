<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PomPom - A productivity timer for remote teams</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%90%A9%3C/text%3E%3C/svg%3E">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0B1120;
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png'), linear-gradient(135deg, #0B1120 0%, #1A2942 100%);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .btn-primary {
            background: linear-gradient(135deg, #00A6A6, #007A7A);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(0, 166, 166, 0.3);
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(0, 166, 166, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }


        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .form-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #E0E0E0;
        }
        .form-input::placeholder {
            color: #888;
        }
        .form-input:focus {
            outline: none;
            border-color: #00A6A6;
            box-shadow: 0 0 0 2px rgba(0, 166, 166, 0.5);
        }

        .nav-btn {
            transition: all 0.2s ease-in-out;
        }

        .nav-btn.active {
            background-color: rgba(0, 166, 166, 0.2);
            color: #00A6A6;
            border-bottom-color: #00A6A6;
        }
        .nav-btn:not(.active):hover {
             background-color: rgba(255, 255, 255, 0.1);
             color: #fff;
        }

        .participant-avatar {
             background: linear-gradient(135deg, #007A7A, #1A2942);
        }

        .kawaii-float {
            animation: kawaii-float 4s ease-in-out infinite;
        }

        @keyframes kawaii-float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-6px); }
        }

        .hidden {
            display: none !important;
        }

        /* Spinner for loading states */
        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid #00A6A6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body class="text-gray-200">

    <div id="app" class="h-screen w-screen flex items-center justify-center p-4 antialiased">

        <!-- Combined Landing & Name Input Page -->
        <div id="welcome-page" class="w-full max-w-md mx-auto">
            <div class="glass-card rounded-2xl p-8 text-center">
                <div class="mx-auto bg-gradient-to-br from-teal-400 to-blue-500 w-20 h-20 rounded-full flex items-center justify-center mb-6 shadow-lg">
                    <span class="text-4xl">üêï</span>
                </div>
                <h1 class="text-4xl font-bold text-white mb-2">Welcome to PomPom</h1>
                <p class="text-gray-400 mb-8">Your team's focus timer.</p>

                <div class="space-y-6 text-left">
                    <div>
                        <label for="session-name-input" class="block text-sm font-medium text-gray-300 mb-2">Team Name</label>
                        <div class="relative">
                            <input id="session-name-input" type="text" placeholder="e.g., project-phoenix" class="form-input w-full rounded-lg py-3 px-4 transition">
                            <p class="text-xs text-gray-500 mt-1 pl-1">Leave blank for a random name.</p>
                        </div>
                    </div>
                    <div>
                        <label for="user-name-setup-input" class="block text-sm font-medium text-gray-300 mb-2">Your Name</label>
                        <div class="flex items-center gap-2">
                            <input id="user-name-setup-input" type="text" placeholder="Enter your name" class="form-input w-full rounded-lg py-3 px-4 transition">
                            <button id="shuffle-user-name-btn" class="btn-secondary h-12 w-12 flex-shrink-0 rounded-lg flex items-center justify-center" title="Generate random name">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 16v-2m0-8v4m-4-2h8m-8 6h8m-4-2V8m0 12v-2m0-8V4m0 4v4m0 4v4" /></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <button id="start-session-btn" class="btn-primary w-full py-3 mt-10 rounded-lg text-lg font-semibold text-white">
                    Start Focusing
                </button>
            </div>
        </div>

        <!-- Session Page -->
        <div id="session-page" class="hidden h-full w-full max-w-6xl mx-auto glass-card rounded-3xl flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="flex items-center justify-between p-4 border-b border-white/10 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-gradient-to-br from-teal-400 to-blue-500 w-10 h-10 rounded-full flex items-center justify-center">
                        <span class="text-2xl">üêï</span>
                    </div>
                    <div>
                        <h2 id="session-header-name" class="font-bold text-white"></h2>
                        <button id="copy-link-btn" class="text-xs text-gray-400 hover:text-teal-400 transition">
                            Copy Share Link üîó
                        </button>
                    </div>
                </div>
                 <div class="flex items-center gap-2">
                     <button id="settings-btn" class="btn-secondary h-10 w-10 rounded-lg flex items-center justify-center" title="Settings">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </button>
                     <button id="leave-btn" class="bg-red-500/20 text-red-300 hover:bg-red-500/40 hover:text-white h-10 px-4 rounded-lg flex items-center justify-center text-sm font-medium transition" title="Leave Session">
                        Leave
                    </button>
                 </div>
            </header>

            <!-- Main Content -->
            <main class="flex-1 flex overflow-hidden">
                <!-- Main View -->
                                <!-- Main View -->
                <div id="timer-view" class="flex-1 flex flex-col items-center justify-center p-8 overflow-y-auto">
                    <div id="timer-display" class="text-8xl md:text-9xl font-bold text-white tracking-tighter kawaii-float">25:00</div>
                    <div id="timer-mode-display" class="text-xl text-teal-300 mt-2 mb-6">Focus Time</div>

                    <div class="w-full max-w-md mb-6">
                        <div class="flex gap-2">
                            <input id="goal-input" type="text" placeholder="Current task (top of list)" class="form-input flex-1 rounded-lg text-sm px-4 py-3" readonly>
                            <button id="breakdown-task-btn" class="btn-secondary flex-shrink-0 px-4 rounded-lg font-semibold text-white text-sm" title="Break down top task with AI">‚ú® Break down</button>
                        </div>
                    </div>

                    <div class="flex items-center gap-4 mb-8">
                        <button id="start-pause-btn" class="btn-primary text-xl px-10 py-4 rounded-xl font-bold">Start</button>
                        <button id="reset-btn" class="btn-secondary text-gray-300 px-6 py-4 rounded-xl font-semibold">Reset</button>
                    </div>

                    <div id="mode-controls" class="flex items-center justify-center gap-2 flex-wrap">
                        <button data-mode="pomodoro25" class="mode-btn btn-secondary px-3 py-1 rounded-full text-xs font-medium">Focus (25m)</button>
                        <button data-mode="shortBreak" class="mode-btn btn-secondary px-3 py-1 rounded-full text-xs font-medium">Short Break (5m)</button>
                        <button data-mode="longBreak" class="mode-btn btn-secondary px-3 py-1 rounded-full text-xs font-medium">Long Break (15m)</button>
                    </div>
                </div>

                <!-- Right Sidebar (Team/Tasks/Chat) -->
                <aside class="w-96 border-l border-white/10 flex flex-col bg-black/10">
                    <nav class="flex-shrink-0 border-b border-white/10">
                         <button data-view="tasks" class="nav-btn w-1/3 py-3 text-sm font-semibold text-gray-400 border-b-2 border-transparent">Tasks</button>
                         <button data-view="participants" class="nav-btn w-1/3 py-3 text-sm font-semibold text-gray-400 border-b-2 border-transparent active">Team</button>
                         <button data-view="planner" class="nav-btn w-1/3 py-3 text-sm font-semibold text-gray-400 border-b-2 border-transparent">Planner</button>
                    </nav>

                    <div class="flex-1 overflow-y-auto p-4">

                        <!-- Tasks View -->
                        <div id="tasks-view" class="hidden">
                            <h3 class="font-semibold text-white mb-3">Session Tasks</h3>
                            <div id="todo-list" class="space-y-2"></div>
                             <div class="flex gap-2 mt-4">
                                <input id="todo-idea-input" type="text" placeholder="Add a new task idea..." class="form-input flex-1 rounded-lg text-sm px-3 py-2">
                                <button id="todo-add-btn" class="btn-primary flex-shrink-0 px-4 rounded-lg font-semibold text-white text-sm flex items-center gap-2">
                                    ‚ú® Add
                                </button>
                            </div>
                        </div>

                        <!-- Participants View -->
                        <div id="participants-view" class="">
                             <h3 class="font-semibold text-white mb-3">Team Members (<span id="participant-count">0</span>)</h3>
                             <div id="participants-list" class="space-y-3"></div>
                             <div class="mt-4">
                                <button id="start-meet-btn" class="btn-primary w-full py-2 rounded-lg font-semibold text-white text-sm flex items-center justify-center gap-2">
                                    üìπ Start Meeting
                                </button>
                             </div>
                        </div>

                        <!-- Planner View -->
                        <div id="planner-view" class="hidden">
                            <h3 class="font-semibold text-white mb-3">Planner</h3>
                            <div id="calendar-container"></div>
                        </div>
                    </div>
                </aside>
            </main>
        </div>

        <!-- Chat Popup -->
        <div id="chat-popup-container" class="fixed bottom-6 right-6 z-20">
            <div id="chat-popup" class="hidden absolute bottom-20 right-0 w-80 h-96 glass-card rounded-2xl flex flex-col overflow-hidden">
                <header class="p-4 border-b border-white/10 flex-shrink-0 flex justify-between items-center">
                    <h3 class="font-semibold text-white">Team Chat</h3>
                    <div class="flex gap-2">
                        <button id="summarize-chat-btn" class="btn-secondary text-xs px-2 py-1 rounded-lg">‚ú® Sum</button>
                        <button id="icebreaker-btn" class="btn-secondary text-xs px-2 py-1 rounded-lg">üßä</button>
                    </div>
                </header>
                <div id="chat-messages" class="flex-1 space-y-3 text-sm p-4 overflow-y-auto bg-black/10"></div>
                <div class="p-4 border-t border-white/10">
                    <div class="flex gap-2">
                        <input id="chat-input" type="text" placeholder="Send a message..." class="form-input flex-1 rounded-lg text-sm px-3 py-2">
                        <button id="send-chat-btn" class="btn-primary flex-shrink-0 px-4 rounded-lg font-semibold text-white text-sm">Send</button>
                    </div>
                </div>
            </div>
            <button id="chat-popup-btn" class="bg-teal-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
            </button>
            <div id="ai-agent-popup" class="hidden absolute bottom-20 right-20 w-80 h-96 glass-card rounded-2xl flex flex-col overflow-hidden z-10">
                <header class="p-4 border-b border-white/10 flex-shrink-0 flex justify-between items-center">
                    <h3 class="font-semibold text-white">AI Agent</h3>
                </header>
                <div id="ai-agent-messages" class="flex-1 space-y-3 text-sm p-4 overflow-y-auto bg-black/10"></div>
                <div class="p-4 border-t border-white/10">
                    <div class="flex gap-2">
                        <input id="ai-agent-input" type="text" placeholder="Ask to add task, start timer, reorder..." class="form-input flex-1 rounded-lg text-sm px-3 py-2">
                        <button id="ai-agent-send" class="btn-primary flex-shrink-0 px-4 rounded-lg font-semibold text-white text-sm">Run</button>
                    </div>
                </div>
            </div>
            <button id="ai-agent-btn" class="bg-purple-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center mr-2">
                <span class="text-2xl">ü§ñ</span>
            </button>
        </div>

        <!-- Modals would go here, simplified for brevity -->
        <div id="end-session-modal" class="hidden"></div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="glass-card rounded-2xl p-6 w-full max-w-md mx-4">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-white">Settings</h2>
                    <button id="close-settings-btn" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Sound Settings -->
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-white font-medium">Sound Effects</label>
                            <p class="text-gray-400 text-sm">Enable timer and notification sounds</p>
                        </div>
                        <button id="sound-toggle-btn" class="w-12 h-6 bg-gray-600 rounded-full relative transition-colors">
                            <div id="sound-toggle-slider" class="w-5 h-5 bg-white rounded-full absolute top-0.5 transition-transform"></div>
                        </button>
                    </div>

                    <!-- Test Sound Button -->
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-white font-medium">Test Sounds</label>
                            <p class="text-gray-400 text-sm">Test your audio settings</p>
                        </div>
                        <button id="test-sound-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm">
                            üîä Test
                        </button>
                    </div>

                    <!-- Audio Diagnostics -->
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-white font-medium">Audio Diagnostics</label>
                            <p class="text-gray-400 text-sm">Check audio system status</p>
                        </div>
                        <button id="audio-diagnostics-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm">
                            üîç Check
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="toast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-teal-500 text-white px-4 py-2 rounded-lg shadow-lg text-sm z-50"></div>

    </div>

    <!-- Load sound functions -->
    <script src="src/sound.js"></script>

    <script type="module">
        // Load meet functionality
        try {
            const { createHandleStartMeet } = await import('./src/meet.js');
            window.__createHandleStartMeet = createHandleStartMeet;
        } catch (e) {
            console.error('Could not load meet.js:', e);
        }

        // --- Sound Settings ---
        let isSoundEnabled = localStorage.getItem('pompom_sound_enabled') === 'true';
        // Default sound ON for first-time users
        if (localStorage.getItem('pompom_sound_enabled') === null) {
            isSoundEnabled = true;
            localStorage.setItem('pompom_sound_enabled', 'true');
        }
        // Make sound settings available globally for sound.js
        window.isSoundEnabled = isSoundEnabled;

        // Initialize audio context for WebAudio sounds
        let audioCtx = null;
        function initAudioContext() {
            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    window.audioCtx = audioCtx;
                }
                // Resume context if suspended (required by some browsers)
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                return audioCtx;
            } catch (e) {
                console.warn('Could not initialize audio context:', e);
                return null;
            }
        }

        // Initialize audio context on first user interaction
        function initAudioOnInteraction() {
            initAudioContext();
            // Remove listeners after first initialization
            document.removeEventListener('click', initAudioOnInteraction);
            document.removeEventListener('keydown', initAudioOnInteraction);
        }
        document.addEventListener('click', initAudioOnInteraction);
        document.addEventListener('keydown', initAudioOnInteraction);

        // --- DOM Elements ---
        const welcomePage = document.getElementById('welcome-page');
        const sessionPage = document.getElementById('session-page');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const soundToggleBtn = document.getElementById('sound-toggle-btn');
        const soundToggleSlider = document.getElementById('sound-toggle-slider');
        const testSoundBtn = document.getElementById('test-sound-btn');
        const audioDiagnosticsBtn = document.getElementById('audio-diagnostics-btn');
        const sessionNameInput = document.getElementById('session-name-input');
        const userNameSetupInput = document.getElementById('user-name-setup-input');
        const shuffleUserNameBtn = document.getElementById('shuffle-user-name-btn');
        const startSessionBtn = document.getElementById('start-session-btn');
        const sessionHeaderName = document.getElementById('session-header-name');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const goalInput = document.getElementById('goal-input');
        const breakdownTaskBtn = document.getElementById('breakdown-task-btn');
        const viewButtons = document.querySelectorAll('.nav-btn');
        const participantsView = document.getElementById('participants-view');
        const tasksView = document.getElementById('tasks-view');
        const plannerView = document.getElementById('planner-view');
        const todoIdeaInput = document.getElementById('todo-idea-input');
        const todoAddBtn = document.getElementById('todo-add-btn');
        const todoList = document.getElementById('todo-list');
        const chatPopupBtn = document.getElementById('chat-popup-btn');
        const chatPopup = document.getElementById('chat-popup');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const summarizeChatBtn = document.getElementById('summarize-chat-btn');
        const icebreakerBtn = document.getElementById('icebreaker-btn');
        const aiAgentBtn = document.getElementById('ai-agent-btn');
        const aiAgentPopup = document.getElementById('ai-agent-popup');
        const aiAgentInput = document.getElementById('ai-agent-input');
        const aiAgentSend = document.getElementById('ai-agent-send');
        const aiAgentMessages = document.getElementById('ai-agent-messages');
        const startMeetBtn = document.getElementById('start-meet-btn');
        const toastEl = document.getElementById('toast');


        // --- App State ---
        let sessionId = '';
        let userName = '';
        let tasks = []; // In-memory task list for this example

        // --- Groq API Helper (via backend proxy) ---
        async function callGroqAPI(prompt) {
            try {
                const body = {
                    model: 'llama-3.1-8b-instant',
                    messages: [
                        { role: 'system', content: 'Respond ONLY with compact JSON. No prose.' },
                        { role: 'user', content: prompt }
                    ],
                    temperature: 0.3,
                    max_tokens: 200
                };
                const response = await fetch('/api/groq', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!response.ok) throw new Error(`Groq API error ${response.status}`);
                const data = await response.json();
                return data?.choices?.[0]?.message?.content || '';
            } catch (error) {
                console.error('Groq call failed:', error);
                showToast('AI is unavailable right now. Please try again later.');
                return null;
            }
        }

        /**
         * Robustly extracts a JSON object from a string that may contain Markdown fences.
         */
        function extractJSON(text) {
            if (!text) return null;
            // Match the JSON content inside the Markdown code block
            const match = text.match(/```json\s*([\s\S]*?)\s*```/);
            if (match && match[1]) {
                try {
                    return JSON.parse(match[1]);
                } catch (e) {
                    console.error("Failed to parse extracted JSON:", e);
                    return null;
                }
            }
            // If no Markdown block, try parsing the whole string
            try {
                return JSON.parse(text);
            } catch (e) {
                // Not a raw JSON string
            }
            return null;
        }

        // --- UI Logic ---
        function showToast(message) {
            toastEl.textContent = message;
            toastEl.classList.remove('hidden');
            setTimeout(() => {
                toastEl.classList.add('hidden');
            }, 3000);
        }

        function renderTasks() {
            todoList.innerHTML = '';
            if (tasks.length === 0) {
                todoList.innerHTML = `<p class="text-gray-400 text-sm">No tasks yet. Add one!</p>`;
                return;
            }
            tasks.forEach((task, index) => {
                const taskEl = document.createElement('div');
                taskEl.className = `p-2 rounded-lg flex justify-between items-center ${task.completed ? 'bg-white/5 text-gray-500' : 'bg-white/10'}`;
                taskEl.innerHTML = `
                    <span class="${task.completed ? 'line-through' : ''}">${task.text}</span>
                    <div class="flex gap-2">
                        <button data-index="${index}" class="toggle-task-btn text-xs">${task.completed ? 'Undo' : 'Done'}</button>
                        <button data-index="${index}" class="delete-task-btn text-xs text-red-400">Del</button>
                    </div>
                `;
                todoList.appendChild(taskEl);
            });
        }

        function switchView(view) {
            [participantsView, tasksView, plannerView].forEach(v => v.classList.add('hidden'));
            viewButtons.forEach(b => b.classList.remove('active'));

            document.querySelector(`[data-view="${view}"]`).classList.add('active');
            document.getElementById(`${view}-view`).classList.remove('hidden');

            if (view === 'planner' && !plannerView.dataset.loaded) {
                fetch('src/calendar.html')
                    .then(response => response.text())
                    .then(html => {
                        const container = document.getElementById('calendar-container');
                        if (container) container.innerHTML = html;
                        plannerView.dataset.loaded = true;
                    })
                    .catch(error => {
                        console.error('Failed to load calendar:', error);
                        document.getElementById('calendar-container').innerHTML = '<p class="text-red-400">Could not load planner. Please try again later.</p>';
                    });
            }
        }

        // --- Event Listeners ---
        copyLinkBtn.addEventListener('click', () => {
            const shareUrl = `${window.location.origin}${window.location.pathname}?session=${sessionId}`;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showToast('Share link copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy link: ', err);
                    showToast('Could not copy link.');
                });
            } else {
                showToast('Clipboard access is not available.');
            }
        });

        startSessionBtn.addEventListener('click', () => {
            sessionId = sessionNameInput.value.trim() || generateRandomTeamName();
            userName = userNameSetupInput.value.trim() || generateRandomUserName();

            if (!userName) {
                showToast("Please enter your name to start.");
                return;
            }
        // AI Agent toggle
        aiAgentBtn.addEventListener('click', () => {
            aiAgentPopup.classList.toggle('hidden');
        });

        // Simple message helper for agent panel
        function aiAgentAppend(role, text) {
            const row = document.createElement('div');
            row.className = role === 'user' ? 'text-right' : 'text-left';
            const bubble = document.createElement('div');
            bubble.className = 'inline-block px-3 py-2 rounded-lg ' + (role === 'user' ? 'bg-purple-600 text-white' : 'bg-white/10 text-white');
            bubble.textContent = text;
            row.appendChild(bubble);
            aiAgentMessages.appendChild(row);
            aiAgentMessages.scrollTop = aiAgentMessages.scrollHeight;
        }

        // Agent command executor: parse intent then act on UI
        async function aiAgentHandle(inputText) {
            aiAgentAppend('user', inputText);
            // Ask Groq to classify intent to minimal JSON
            const prompt = `You are a UI assistant. Given a natural language instruction, output ONLY compact JSON with fields: action, text, index, mode. Actions: add_task, start_timer, pause_timer, reset_timer, reorder_tasks, delete_task, suggest_task. index is zero-based for reorder/delete; mode is one of pomodoro25, shortBreak, longBreak for switching modes. Example: {"action":"add_task","text":"Implement login"}. Instruction: ${inputText}`;
            let content = await callGroqAPI(prompt);
            const cmd = extractJSON(content) || {};
            let resultMsg = '';
            try {
        // Add task on Enter in ideas input
        if (todoIdeaInput) {
            todoIdeaInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const idea = (todoIdeaInput.value || '').trim();
                    if (!idea) return;
                    tasks.push({ text: idea, completed: false });
                    renderTasks();
                    todoIdeaInput.value = '';
                }
            });
        }
                switch ((cmd.action || '').toLowerCase()) {
                    case 'add_task': {
                        const t = (cmd.text || '').trim();
                        if (t) { tasks.unshift({ text: t, completed: false }); renderTasks(); }
                        resultMsg = t ? `Added task: ${t}` : 'No task text provided';
                        break;
                    }
                    case 'suggest_task': {
                        const idea = (cmd.text || '').trim() || (aiAgentInput.value || '').trim();
                        if (idea) {
                            const result = await callGroqAPI(`Break this into 2-4 subtasks as a JSON array of short strings: ${idea}`);
                            const arr = extractJSON(result);
                            if (Array.isArray(arr) && arr.length) {
                                arr.reverse().forEach(txt => tasks.unshift({ text: String(txt), completed: false }));
                                renderTasks();
                                resultMsg = `Added ${arr.length} subtasks.`;
                            } else {
                                tasks.unshift({ text: idea, completed: false });
                                renderTasks();
                                resultMsg = 'Added as a single task.';
                            }
                        } else resultMsg = 'No idea provided';
                        break;
                    }
                    case 'start_timer': startTimer(); resultMsg = 'Timer started'; break;
                    case 'pause_timer': pauseTimer(); resultMsg = 'Timer paused'; break;
                    case 'reset_timer': resetTimer(); resultMsg = 'Timer reset'; break;
                    case 'reorder_tasks': {
                        const i = Number(cmd.index), j = Number(cmd.to);
                        if (Number.isInteger(i) && Number.isInteger(j) && i>=0 && j>=0 && i<tasks.length && j<tasks.length) {
                            const [moved] = tasks.splice(i, 1);
                            tasks.splice(j, 0, moved);
                            renderTasks();
                            resultMsg = `Moved task from ${i} to ${j}`;
                        } else resultMsg = 'Invalid indexes';
                        break;
                    }
                    case 'delete_task': {
                        const i = Number(cmd.index);
                        if (Number.isInteger(i) && i>=0 && i<tasks.length) {
                            const [del] = tasks.splice(i,1);
                            renderTasks();
                            resultMsg = `Deleted task: ${del.text}`;
                        } else resultMsg = 'Invalid index';
                        break;
                    }
                    case 'set_mode': {
                        const m = String(cmd.mode||'');
                        if (['pomodoro25','shortBreak','longBreak'].includes(m)) { setMode(m); resultMsg = `Mode set to ${m}`; }
                        else resultMsg = 'Invalid mode';
                        break;
                    }
                    default:
                        // Unknown action: treat as a normal chat dialog.
                        // Ask the model to respond conversationally and show the reply.
                        const reply = await callGroqAPI(`You are a helpful teammate. Respond conversationally to: ${JSON.stringify(inputText)}`);
                        resultMsg = reply || '‚Ä¶';
                }
            } catch (e) {
                console.error('Agent error', e);
                resultMsg = 'Action failed.';
            }
            aiAgentAppend('assistant', resultMsg);
        }

        aiAgentSend.addEventListener('click', async () => {
            const txt = (aiAgentInput.value || '').trim();
            if (!txt) return;
            aiAgentInput.value = '';
            await aiAgentHandle(txt);
        });
        aiAgentInput.addEventListener('keypress', async (e) => { if (e.key==='Enter') { e.preventDefault(); aiAgentSend.click(); }});


            welcomePage.classList.add('hidden');
            sessionPage.classList.remove('hidden');
            sessionHeaderName.textContent = `Team: ${sessionId}`;
        });

        shuffleUserNameBtn.addEventListener('click', () => {
            userNameSetupInput.value = generateRandomUserName();
        });

        viewButtons.forEach(button => {
            button.addEventListener('click', () => {
                const view = button.dataset.view;
                switchView(view);
            });
        });

        chatPopupBtn.addEventListener('click', () => {
            chatPopup.classList.toggle('hidden');
        });

        breakdownTaskBtn.addEventListener('click', async () => {
            const topTask = tasks.find(t => !t.completed);
            if (!topTask) {
                showToast("No task to break down.");
                return;
            }

            breakdownTaskBtn.innerHTML = `<div class="spinner"></div>`;
            breakdownTaskBtn.disabled = true;

            const prompt = `Based on the user's task "${topTask.text}", break it down into a JSON array of 2-4 specific, actionable sub-tasks. The user is in a team setting. The JSON should be an array of strings. Example: for "build login page", return ["Design UI in Figma", "Develop HTML/CSS structure", "Implement form validation", "Connect to authentication API"]. Return ONLY the JSON array.`;
            const result = await callGroqAPI(prompt);
            const subtasks = extractJSON(result);

            if (subtasks && Array.isArray(subtasks)) {
                const topTaskIndex = tasks.findIndex(t => t === topTask);
                if (topTaskIndex > -1) {
                    const newTasks = subtasks.map(t => ({ text: t, completed: false }));
                    tasks.splice(topTaskIndex, 1, ...newTasks);
                    showToast("Task broken down by AI.");
                }
            } else {
                showToast("AI couldn't break down the task.");
            }

            renderTasks();
            breakdownTaskBtn.innerHTML = `‚ú® Break down`;
            breakdownTaskBtn.disabled = false;
        });

        todoAddBtn.addEventListener('click', () => {
            const idea = todoIdeaInput.value.trim();
            if (!idea) return;
            tasks.push({ text: idea, completed: false });
            renderTasks();
            todoIdeaInput.value = '';
        });

        todoIdeaInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                todoAddBtn.click();
            }
        });

        todoList.addEventListener('click', (e) => {
            const index = e.target.dataset.index;
            if (e.target.classList.contains('toggle-task-btn')) {
                tasks[index].completed = !tasks[index].completed;
            }
            if (e.target.classList.contains('delete-task-btn')) {
                tasks.splice(index, 1);
            }
            renderTasks();
        });

        summarizeChatBtn.addEventListener('click', async () => {
            const messages = Array.from(chatMessages.children).map(el => el.textContent).join('\\n');
            if (messages.length < 50) {
                showToast("Not enough chat history to summarize.");
                return;
            }
            summarizeChatBtn.disabled = true;
            summarizeChatBtn.innerHTML = `<div class="spinner"></div>`;
            const prompt = `Summarize the key decisions, action items, and overall sentiment of the following chat conversation. Present it in a few bullet points. \\n\\nChat History:\\n${messages}`;
            const summary = await callGroqAPI(prompt);
            if (summary) {
                const summaryEl = document.createElement('div');
                summaryEl.className = 'p-2 bg-teal-900/50 rounded-lg text-xs italic mt-2';
                summaryEl.textContent = `‚ú® Summary: ${summary}`;
                chatMessages.appendChild(summaryEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            summarizeChatBtn.disabled = false;
            summarizeChatBtn.textContent = '‚ú® Sum';
        });

        icebreakerBtn.addEventListener('click', async () => {
            icebreakerBtn.disabled = true;
            icebreakerBtn.innerHTML = `<div class="spinner"></div>`;
            const prompt = "Generate a fun, safe-for-work icebreaker question for a remote team to discuss.";
            const question = await callGroqAPI(prompt);
            if (question) {
                chatInput.value = question.replace(/"/g, '');
            }
            icebreakerBtn.disabled = false;
            icebreakerBtn.textContent = 'üßä';
        });

        // Start Meeting functionality
        startMeetBtn.addEventListener('click', async () => {
            try {
                // Play ringing sound for all users (if available)
                if (typeof playMeetingRing === 'function') {
                    playMeetingRing();
                }

                // Open Google Meet in new tab
                window.open('https://meet.google.com/new', '_blank');
                showToast('Opening Google Meet...');

                // Add message to chat indicating meeting started
                const meetMessage = `${userName || 'Someone'} started a Google Meet. Check the new tab for the meeting link.`;

                // Simple local chat message for now
                const chatMessagesDiv = document.getElementById('chat-messages');
                if (chatMessagesDiv) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'flex items-start gap-3';
                    messageDiv.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-teal-500 flex items-center justify-center text-white text-xs font-bold">
                            ${(userName || 'U')[0].toUpperCase()}
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-gray-400 mb-1">${userName || 'You'} ‚Ä¢ now</div>
                            <div class="text-white">${meetMessage}</div>
                        </div>
                    `;
                    chatMessagesDiv.appendChild(messageDiv);
                    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                }

                // Switch to participants view to show the meeting was started
                switchView('participants');

            } catch (error) {
                console.error('Error starting meeting:', error);
                showToast('Could not start meeting');
            }
        });

        // --- Settings Modal Logic ---
        function updateSoundToggleUI() {
            if (isSoundEnabled) {
                soundToggleBtn.classList.add('bg-teal-500');
                soundToggleBtn.classList.remove('bg-gray-600');
                soundToggleSlider.style.transform = 'translateX(24px)';
            } else {
                soundToggleBtn.classList.remove('bg-teal-500');
                soundToggleBtn.classList.add('bg-gray-600');
                soundToggleSlider.style.transform = 'translateX(0px)';
            }
        }

        function toggleSound() {
            isSoundEnabled = !isSoundEnabled;
            localStorage.setItem('pompom_sound_enabled', isSoundEnabled);
            window.isSoundEnabled = isSoundEnabled;
            updateSoundToggleUI();

            // Play confirmation sound if enabled
            if (isSoundEnabled && typeof playGong === 'function') {
                setTimeout(() => playGong(), 100);
            }
        }

        // Settings button event listeners
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
            updateSoundToggleUI();
        });

        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        // Close modal when clicking outside
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.add('hidden');
            }
        });

        soundToggleBtn.addEventListener('click', toggleSound);

        testSoundBtn.addEventListener('click', async () => {
            // Disable button temporarily to prevent spam clicking
            testSoundBtn.disabled = true;
            testSoundBtn.textContent = 'üîä Playing...';

            try {
                // Initialize audio context if needed
                initAudioContext();

                let soundPlayed = false;

                // Try WebAudio-based sounds first (better quality)
                if (typeof playGong === 'function' && isSoundEnabled) {
                    playGong();
                    soundPlayed = true;
                    showToast('üîä Gong sound played!');
                } else if (typeof playMeetingRing === 'function' && isSoundEnabled) {
                    playMeetingRing();
                    soundPlayed = true;
                    showToast('üîä Meeting ring played!');
                } else {
                    // Fallback to basic audio
                    try {
                        const audio = new Audio('https://cdn.jsdelivr.net/gh/DoctorKhan/pompom-assets/gong.mp3');
                        audio.volume = 0.5; // Set reasonable volume

                        await audio.play();
                        soundPlayed = true;
                        showToast('üîä Fallback audio played!');
                    } catch (audioError) {
                        console.warn('Audio play failed:', audioError);
                        showToast('‚ùå Could not play sound - check audio permissions or volume');
                    }
                }

                // If no sound was played, show appropriate message
                if (!soundPlayed) {
                    if (!isSoundEnabled) {
                        showToast('üîá Sound is disabled - enable it first');
                    } else {
                        showToast('‚ùå No sound functions available');
                    }
                }

            } catch (error) {
                console.error('Test sound error:', error);
                showToast('‚ùå Sound test failed: ' + error.message);
            }

            // Re-enable button after delay
            setTimeout(() => {
                testSoundBtn.disabled = false;
                testSoundBtn.textContent = 'üîä Test';
            }, 2000);
        });

        // Audio diagnostics button
        audioDiagnosticsBtn.addEventListener('click', () => {
            const diagnostics = [];

            // Check sound enabled status
            diagnostics.push(`Sound Enabled: ${isSoundEnabled ? '‚úÖ Yes' : '‚ùå No'}`);

            // Check audio context
            if (window.audioCtx) {
                diagnostics.push(`Audio Context: ‚úÖ Available (${window.audioCtx.state})`);
            } else {
                diagnostics.push(`Audio Context: ‚ùå Not initialized`);
            }

            // Check sound functions
            const soundFunctions = ['playGong', 'playDing', 'playMeetingRing'];
            soundFunctions.forEach(fn => {
                if (typeof window[fn] === 'function') {
                    diagnostics.push(`${fn}: ‚úÖ Available`);
                } else {
                    diagnostics.push(`${fn}: ‚ùå Missing`);
                }
            });

            // Check browser audio support
            try {
                const audio = new Audio();
                diagnostics.push(`Browser Audio: ‚úÖ Supported`);
            } catch (e) {
                diagnostics.push(`Browser Audio: ‚ùå Not supported`);
            }

            // Show diagnostics in toast (multiple toasts)
            diagnostics.forEach((diagnostic, index) => {
                setTimeout(() => {
                    showToast(diagnostic);
                }, index * 1000);
            });
        });

        // Initialize sound toggle UI
        updateSoundToggleUI();

        // --- Timer Logic ---
        const startPauseBtn = document.getElementById('start-pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const timerDisplay = document.getElementById('timer-display');
        const timerModeDisplay = document.getElementById('timer-mode-display');
        const modeControls = document.getElementById('mode-controls');

        const MODE_DURATIONS = {
            pomodoro25: { seconds: 25 * 60, label: 'Focus Time' },
            shortBreak: { seconds: 5 * 60, label: 'Short Break' },
            longBreak: { seconds: 15 * 60, label: 'Long Break' },
        };

        // Allow tests to override duration (window.__TIMER_SECONDS_OVERRIDE)
        function getModeSeconds() {
            try {
                const o = typeof window !== 'undefined' && window.__TIMER_SECONDS_OVERRIDE;
                const n = Number(o);
                if (Number.isFinite(n) && n > 0) return n;
            } catch {}
            return MODE_DURATIONS[currentMode].seconds;
        }

        let currentMode = 'pomodoro25';
        let remainingSeconds = getModeSeconds();
        let timerInterval = null;
        let running = false;
        let targetEndTs = 0;

        function fmtTime(totalSeconds) {
            const m = Math.floor(totalSeconds / 60);
            const s = Math.floor(totalSeconds % 60);
            return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function renderTimer() {
            timerDisplay.textContent = fmtTime(remainingSeconds);
            timerModeDisplay.textContent = MODE_DURATIONS[currentMode].label;
            startPauseBtn.textContent = running ? 'Pause' : 'Start';
        }

        function tick() {
            const now = Date.now();
            const leftMs = Math.max(0, targetEndTs - now);
            remainingSeconds = Math.ceil(leftMs / 1000);
            renderTimer();
            if (remainingSeconds <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                running = false;
                try { if (typeof window !== 'undefined' && typeof window.playGong === 'function') window.playGong(); } catch {}
                remainingSeconds = getModeSeconds();
                renderTimer();
            }
        }

        function startTimer() {
            if (running) return;
            // Snap to test override if present
            try {
                const o = typeof window !== 'undefined' && Number(window.__TIMER_SECONDS_OVERRIDE);
                if (Number.isFinite(o) && o > 0) remainingSeconds = o;
            } catch {}
            running = true;
            targetEndTs = Date.now() + remainingSeconds * 1000;
            renderTimer();
            timerInterval = setInterval(tick, 250);
        }

        function pauseTimer() {
            if (!running) return;
            running = false;
            clearInterval(timerInterval);
            timerInterval = null;
            // Recompute remaining based on now
            const now = Date.now();
            remainingSeconds = Math.max(0, Math.ceil((targetEndTs - now) / 1000));
            renderTimer();
        }

        function resetTimer() {
            running = false;
            clearInterval(timerInterval);
            timerInterval = null;
            remainingSeconds = MODE_DURATIONS[currentMode].seconds;
            renderTimer();
        }

        function setMode(mode) {
            if (!MODE_DURATIONS[mode]) return;
            currentMode = mode;
            resetTimer();
        }

        if (startPauseBtn) {
            startPauseBtn.addEventListener('click', () => {
                if (running) pauseTimer(); else startTimer();
            });
        }
        if (resetBtn) {
            resetBtn.addEventListener('click', resetTimer);
        }
        if (modeControls) {
            modeControls.addEventListener('click', (e) => {
                const btn = e.target.closest('[data-mode]');
                if (!btn) return;
                setMode(btn.dataset.mode);
            });
        }

        // --- Goal Set / Auto-top behavior and Drag & Drop ---
        const saveGoalBtn = null; // removed button; we auto-show top task

        function topTaskText() {
            const firstOpen = tasks.find(t => !t.completed);
            return firstOpen ? firstOpen.text : (tasks[0] ? tasks[0].text : '');
        }

        function renderTasksWithDnD() {
            // Re-render tasks and attach drag handlers
            todoList.innerHTML = '';
            if (tasks.length === 0) {
                todoList.innerHTML = `<p class="text-gray-400 text-sm">No tasks yet. Add one!</p>`;
            } else {
                tasks.forEach((task, index) => {
                    const taskEl = document.createElement('div');
                    taskEl.className = `p-2 rounded-lg flex justify-between items-center ${task.completed ? 'bg-white/5 text-gray-500' : 'bg-white/10'}`;
                    taskEl.setAttribute('draggable', 'true');
                    taskEl.dataset.index = String(index);
                    taskEl.innerHTML = `
                        <span class="task-text ${task.completed ? 'line-through' : ''}">${task.text}</span>
                        <div class="flex gap-2">
                            <button data-index="${index}" class="toggle-task-btn text-xs">${task.completed ? 'Undo' : 'Done'}</button>
                            <button data-index="${index}" class="delete-task-btn text-xs text-red-400">Del</button>
                        </div>
                    `;
                    taskEl.addEventListener('dragstart', (ev) => {
                        ev.dataTransfer.setData('text/plain', String(index));
                        taskEl.classList.add('opacity-50');
                    });
                    taskEl.addEventListener('dragend', () => {
                        taskEl.classList.remove('opacity-50');
                    });
                    taskEl.addEventListener('dragover', (ev) => ev.preventDefault());
                    taskEl.addEventListener('drop', (ev) => {
                        ev.preventDefault();
                        const fromStr = ev.dataTransfer.getData('text/plain');
                        const from = parseInt(fromStr, 10);
                        const to = index;
                        if (!Number.isInteger(from) || from === to) return;
                        const moved = tasks.splice(from, 1)[0];
                        tasks.splice(to, 0, moved);
                        renderTasksWithDnD();
                        // Auto-show top task as goal
                        const top = topTaskText();
                        if (top) goalInput.value = top;
                    });
                    todoList.appendChild(taskEl);
                });
            // Click-to-edit task text (basic inline editor like original)
            todoList.addEventListener('click', (e) => {
                const txtEl = e.target.closest('.task-text');
                if (!txtEl) return;
                const taskEl = txtEl.closest('[data-index]')?.parentElement || txtEl.closest('div');
                const idxAttr = (txtEl.closest('[data-index]') || e.target).dataset.index;
                const index = parseInt(idxAttr, 10);
                if (!Number.isInteger(index)) return;

                // Build simple inline editor
                const wrap = document.createElement('div');
                wrap.className = 'flex items-center gap-2 w-full';
                const input = document.createElement('input');
                input.type = 'text';
                input.value = tasks[index].text;
                input.className = 'flex-1 bg-white text-black rounded px-2 py-1';
                const save = document.createElement('button');
                save.className = 'btn-primary px-3 py-1 rounded text-white';
                save.textContent = 'Save';
                const cancel = document.createElement('button');
                cancel.className = 'btn-secondary px-3 py-1 rounded text-white';
                cancel.textContent = 'Cancel';

                const originalHTML = taskEl.innerHTML;
                taskEl.innerHTML = '';
                wrap.appendChild(input);
                wrap.appendChild(save);
                wrap.appendChild(cancel);
                taskEl.appendChild(wrap);
                input.focus(); input.select();

                const commit = () => {
                    const v = (input.value || '').trim();
                    if (v) tasks[index].text = v;
                    renderTasksWithDnD();
                };
                const revert = () => { taskEl.innerHTML = originalHTML; };
                save.addEventListener('click', commit);
                cancel.addEventListener('click', () => renderTasksWithDnD());
                input.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter') { ev.preventDefault(); commit(); }
                    if (ev.key === 'Escape') { ev.preventDefault(); renderTasksWithDnD(); }
                });
            });
            }
            // Auto-set goal input to top task
            const top = topTaskText();
            if (top) goalInput.value = top; else if (!goalInput.value) goalInput.value = '';
        }

        if (saveGoalBtn) {
            saveGoalBtn.addEventListener('click', () => {
                const txt = (goalInput.value || '').trim();
                if (!txt) return;
                // Insert as top task
                tasks.unshift({ text: txt, completed: false });
                renderTasksWithDnD();
                showToast('Goal set as top task');
            });
        }

        // Replace plain renderTasks with DnD-enabled renderer
        renderTasks = renderTasksWithDnD;
        renderTasks();

        // Keep existing click handling for toggle/delete
        // (already attached below; works with re-render because of delegation)



        // --- Utility Functions ---
        function generateRandomUserName() {
            const adjectives = ["Cozy", "Brave", "Clever", "Dandy", "Eager", "Fancy", "Gentle", "Happy", "Jolly", "Kind", "Lucky", "Merry", "Nice", "Proud", "Silly", "Witty"];
            const nouns = ["Panda", "Penguin", "Dragon", "Unicorn", "Fox", "Bear", "Lion", "Tiger", "Bunny", "Puppy", "Kitten", "Chipmunk"];
            return `${adjectives[Math.floor(Math.random() * adjectives.length)]} ${nouns[Math.floor(Math.random() * nouns.length)]}`;
        }

        function generateRandomTeamName() {
            const nouns = ["Galaxy", "Comet", "Nova", "Orion", "Pegasus", "Phoenix", "Andromeda", "Draco", "Lyra", "Cygnus"];
            const verbs = ["Quest", "Voyage", "Mission", "Journey", "Expedition", "Odyssey", "Venture", "Trek"];
            return `${verbs[Math.floor(Math.random() * verbs.length)]}${nouns[Math.floor(Math.random() * nouns.length)]}${Math.floor(Math.random() * 900) + 100}`;
        }

        // --- Initial Load ---
        userNameSetupInput.value = generateRandomUserName();
        renderTasks();
        switchView('participants'); // Start with participants view active

    </script>
</body>
</html>

