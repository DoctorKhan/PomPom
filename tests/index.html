<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PomPom Test Suite Dashboard</title>
    <!-- The Inter font family is used for a clean, modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome is used for icons throughout the interface -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        /* CSS variables for a consistent and easily themeable design */
        :root {
            --bg-sidebar: #1a202c;
            --bg-main: #f7fafc;
            --bg-card: #ffffff;
            --bg-interactive: #2d3748;
            --text-primary: #2d3748;
            --text-secondary: #a0aec0;
            --text-light: #e2e8f0;
            --border-color: #e2e8f0;
            --accent-color: #4299e1;
            --accent-color-hover: #2b6cb0;
            --status-pass-bg: #2f855a;
            --status-pass-fg: #48bb78;
            --status-fail-bg: #c53030;
            --status-fail-fg: #f56565;
            --status-running-bg: #b7791f;
            --status-running-fg: #f6ad55;
            --status-idle-bg: #2d3748;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* Main dashboard layout using CSS Grid for a robust two-column structure */
        .test-dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: 100%;
        }

        /* --- Sidebar Styles --- */
        .sidebar {
            background-color: var(--bg-sidebar);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            padding: 24px;
        }

        .sidebar-header {
            margin-bottom: 32px;
        }

        .sidebar-header h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .sidebar-header p {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .sidebar h2 {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin: 24px 0 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--bg-interactive);
        }

        /* --- Status Overview Card --- */
        .status-overview-card {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            transition: background-color 0.3s ease;
        }

        .status-overview-card .status-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .status-overview-card .status-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .status-overview-card .status-summary {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Variants for the status card to provide clear visual feedback */
        .status-idle { background-color: var(--status-idle-bg); }
        .status-running { background-color: var(--status-running-bg); }
        .status-pass { background-color: var(--status-pass-bg); }
        .status-fail { background-color: var(--status-fail-bg); }

        /* --- Test Suites List --- */
        .test-suites ul {
            list-style: none;
        }

        .test-suite-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .test-suite-item .suite-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        .test-suite-item .suite-info i {
            color: var(--text-secondary);
            width: 20px;
            text-align: center;
        }
        .test-suite-item .suite-info .suite-count {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .run-suite-btn {
            background: var(--bg-interactive);
            color: var(--text-light);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .run-suite-btn:hover {
            background: var(--accent-color);
        }
        .run-suite-btn:disabled {
            background: #4a5568;
            cursor: not-allowed;
        }

        /* --- Action Buttons --- */
        .suite-actions {
            margin-top: auto; /* Pushes action buttons to the bottom of the sidebar */
        }
        .suite-actions button {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .suite-actions button:disabled {
             opacity: 0.6;
             cursor: not-allowed;
        }

        #run-all-btn {
            background-color: var(--accent-color);
            color: white;
            margin-bottom: 12px;
        }
        #run-all-btn:hover:not(:disabled) { background-color: var(--accent-color-hover); }

        #clear-results-btn {
            background-color: var(--bg-interactive);
            color: var(--text-light);
        }
        #clear-results-btn:hover:not(:disabled) { background-color: #4a5568; }

        /* --- Main Content Area --- */
        .main-content {
            padding: 32px;
            overflow-y: auto;
            height: 100vh;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: minmax(300px, 45%) 1fr;
            gap: 32px;
            height: 100%;
        }

        /* Card styles for a consistent container look */
        .card {
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .card-header h3 { font-size: 16px; font-weight: 600; }

        .card-body {
            padding: 24px;
            flex-grow: 1;
            overflow: hidden; /* Important for child elements to be contained */
        }

        /* --- App Preview Card --- */
        #load-app-btn {
            background: #edf2f7;
            border: 1px solid #e2e8f0;
            color: var(--text-primary);
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #load-app-btn:hover { background-color: #e2e8f0; }

        #test-iframe {
            width: 100%;
            height: 100%;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        /* --- Test Results Card & Progress Bar --- */
        #test-progress-bar-container {
            width: 200px;
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        #test-progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--accent-color);
            border-radius: 4px;
            transition: width 0.3s ease-in-out, background-color 0.3s ease;
        }

        /* Log container and entries */
        #test-log {
            height: 100%;
            overflow-y: auto;
            font-family: 'SF Mono', 'Fira Code', 'Fira Mono', 'Roboto Mono', monospace;
            font-size: 13px;
        }

        .log-entry {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 4px;
            animation: fadeIn 0.3s ease;
        }

        /* Animation for new log entries */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .log-entry .log-icon { font-weight: bold; }
        .log-pass { background-color: #f0fff4; }
        .log-pass .log-icon { color: var(--status-pass-fg); }
        .log-fail { background-color: #fff5f5; }
        .log-fail .log-icon { color: var(--status-fail-fg); }
        .log-info { background-color: #f0f4ff; }
        .log-info .log-icon { color: var(--accent-color); }

        .log-message { flex-grow: 1; }
        .log-timestamp { color: var(--text-secondary); font-size: 12px; }

        /* Placeholder shown when no tests have been run */
        .log-placeholder {
            display: flex;
            height: 100%;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: var(--text-secondary);
            text-align: center;
        }
        .log-placeholder i { font-size: 48px; margin-bottom: 16px;}

    </style>
</head>
<body>
    <div class="test-dashboard">
        <!-- ===== SIDEBAR ===== -->
        <aside class="sidebar">
            <header class="sidebar-header">
                <h1>🐕 PomPom</h1>
                <p>Test Suite</p>
            </header>

            <div id="status-card" class="status-overview-card status-idle">
                <!-- Status content is generated by JavaScript -->
            </div>

            <nav class="test-suites">
                <h2>Test Suites</h2>
                <ul>
                    <li class="test-suite-item">
                        <div class="suite-info">
                            <i class="fas fa-globe-americas"></i>
                            <span>Browser Tests <span class="suite-count">(25)</span></span>
                        </div>
                        <button class="run-suite-btn" onclick="runBrowserTests()" title="Run Browser Tests"><i class="fas fa-play"></i></button>
                    </li>
                    <li class="test-suite-item">
                        <div class="suite-info">
                            <i class="fas fa-wrench"></i>
                            <span>Basic Tests <span class="suite-count">(32)</span></span>
                        </div>
                        <button class="run-suite-btn" onclick="runBasicTests()" title="Run Basic Tests"><i class="fas fa-play"></i></button>
                    </li>
                    <li class="test-suite-item">
                        <div class="suite-info">
                            <i class="fas fa-link"></i>
                            <span>Integration Tests <span class="suite-count">(25)</span></span>
                        </div>
                        <button class="run-suite-btn" onclick="runIntegrationTests()" title="Run Integration Tests"><i class="fas fa-play"></i></button>
                    </li>
                    <li class="test-suite-item">
                        <div class="suite-info">
                            <i class="fas fa-user-friends"></i>
                            <span>User Flow Tests <span class="suite-count">(35)</span></span>
                        </div>
                        <button class="run-suite-btn" onclick="runUserFlowTests()" title="Run User Flow Tests"><i class="fas fa-play"></i></button>
                    </li>
                </ul>
            </nav>

            <div class="suite-actions">
                <button id="run-all-btn" onclick="runAllTests()">
                    <i class="fas fa-rocket"></i>
                    <span>Run All Tests (117)</span>
                </button>
                <button id="clear-results-btn" onclick="clearResults()">
                    <i class="fas fa-trash-alt"></i>
                    <span>Clear Results</span>
                </button>
                <button id="copy-failed-btn" onclick="copyFailedTestsToClipboard()" title="Copy failed tests to clipboard">
                    <i class="fas fa-clipboard"></i>
                    <span>Copy Failed Tests</span>
                </button>
            </div>
        </aside>

        <!-- ===== MAIN CONTENT ===== -->
        <main class="main-content">
            <div class="content-grid">
                <!-- App Preview Card -->
                <div class="card app-preview-card">
                    <div class="card-header">
                        <h3>App Preview</h3>
                        <button id="load-app-btn" onclick="loadApp()">Reload App</button>
                    </div>
                    <div class="card-body">
                        <div id="app-preview-container" style="width: 100%; height: 100%;"></div>
                    </div>
                </div>

                <!-- Test Results Card -->
                <div class="card test-results-card">
                    <div class="card-header">
                        <h3>Test Results</h3>
                        <div id="test-progress-bar-container">
                            <div id="test-progress-bar"></div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="test-log">
                            <!-- Log entries will be added here by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

        <!-- Hidden iframe that runs legacy tests from tests-old.html -->
        <iframe id="old-tests-iframe" src="about:blank" style="display:none; width:0; height:0; border:0;"></iframe>


    <script>
        // --- STATE MANAGEMENT ---
        let testResults = [];
        const TOTAL_TESTS = 117; // Updated with new error-catching tests
        let isRunning = false;
        let testIframe = null;
        let failedTests = []; // Track failed tests for summary

        // --- UI ELEMENT REFERENCES ---
        const logContainer = document.getElementById('test-log');
        const statusCard = document.getElementById('status-card');
        const progressBar = document.getElementById('test-progress-bar');
        const allButtons = document.querySelectorAll('button');

        // --- CORE UI FUNCTIONS ---

        /**
         * Loads the target application into the preview area for testing.
         */
        async function loadApp() {
            const previewArea = document.getElementById('app-preview-container');
            if (!previewArea) return;
            
            try {
                log('Loading app for testing...', 'info');
                
                // Fetch the main app HTML
                const response = await fetch('../index.html');
                if (!response.ok) {
                    throw new Error(`Failed to load app: ${response.status}`);
                }
                
                const html = await response.text();
                
                // Create a container for the app
                previewArea.innerHTML = `
                    <div id="test-app-container" style="width: 100%; height: 100%; border: 1px solid #e2e8f0; border-radius: 6px; overflow: hidden;">
                        ${html}
                    </div>
                `;
                
                // Execute scripts in the loaded HTML
                const scriptElements = previewArea.querySelectorAll('script');
                scriptElements.forEach(script => {
                    if (script.src) {
                        // External script
                        const newScript = document.createElement('script');
                        newScript.src = script.src;
                        document.head.appendChild(newScript);
                    } else if (script.textContent) {
                        // Inline script
                        try {
                            // For module scripts, we need special handling
                            if (script.type === 'module') {
                                // Create a blob URL for the module script
                                const blob = new Blob([script.textContent], { type: 'application/javascript' });
                                const url = URL.createObjectURL(blob);
                                const newScript = document.createElement('script');
                                newScript.type = 'module';
                                newScript.src = url;
                                document.head.appendChild(newScript);
                            } else {
                                // Regular script
                                new Function(script.textContent)();
                            }
                        } catch (e) {
                            console.error('Error executing script:', e);
                        }
                    }
                });
                
                log('App loaded successfully for testing', 'info');
                
            } catch (error) {
                log(`Failed to load app: ${error.message}`, false);
                previewArea.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                        Failed to load app: ${error.message}
                    </div>
                `;
            }
        }

        /**
         * Waits for the app to load in the preview container.
         */
        function waitForAppLoad() {
            return new Promise((resolve, reject) => {
                const container = document.getElementById('app-preview-container');
                const timeout = setTimeout(() => {
                    reject(new Error('App load timeout'));
                }, 10000); // 10 second timeout
                
                const checkLoaded = () => {
                    const appContainer = document.getElementById('test-app-container');
                    if (appContainer && appContainer.innerHTML) {
                        clearTimeout(timeout);
                        resolve();
                    } else {
                        setTimeout(checkLoaded, 100);
                    }
                };
                
                checkLoaded();
            });
        }

        /**
         * Waits for the test iframe to load (for legacy tests).
         */
        function waitForIframeLoad() {
            return new Promise((resolve, reject) => {
                const iframe = document.getElementById('test-iframe');
                if (!iframe) {
                    reject(new Error('Test iframe not found'));
                    return;
                }

                const timeout = setTimeout(() => {
                    reject(new Error('Iframe load timeout'));
                }, 10000); // 10 second timeout

                const checkLoad = () => {
                    try {
                        if (iframe.contentDocument && iframe.contentWindow) {
                            clearTimeout(timeout);
                            resolve();
                        } else {
                            setTimeout(checkLoad, 100);
                        }
                    } catch (e) {
                        setTimeout(checkLoad, 100);
                    }
                };
                checkLoad();
            });
        }

        /**
         * Resets the test runner state and clears all results from the UI.
         */
        function clearResults() {
            if (isRunning) return;
            testResults = [];
            failedTests = [];
            updateUI();
        }

        /**
         * Shows a summary of failed tests that can be easily copied
         */
        function showFailedTestsSummary() {
            if (failedTests.length === 0) return;

            const summaryText = `
=== FAILED TESTS SUMMARY (${failedTests.length} failures) ===
Copy and paste this to AI for debugging:

${failedTests.map((test, i) => `${i + 1}. ${test}`).join('\n')}

=== END FAILED TESTS ===
            `.trim();

            // Add summary to log
            const div = document.createElement('div');
            div.className = 'log-entry fail';
            div.innerHTML = `
                <div class="log-icon">📋</div>
                <div class="log-content">
                    <div class="log-message">
                        <strong>Failed Tests Summary (Copy-Paste Ready)</strong>
                        <pre style="background: #2a2a2a; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; font-size: 12px;">${summaryText}</pre>
                    </div>
                </div>
                <div class="log-timestamp">${new Date().toLocaleTimeString()}</div>
            `;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Also log to console for easy copying
            console.log(summaryText);
        }

        /**
         * Toggles the disabled state of all buttons to prevent user action during a test run.
         * @param {boolean} shouldDisable - True to disable buttons, false to enable.
         */
        function setButtonsDisabled(shouldDisable) {
            isRunning = shouldDisable;
            allButtons.forEach(btn => btn.disabled = shouldDisable);
        }

        /**
         * Updates all dynamic UI elements based on the current state.
         * This includes the status card, progress bar, and log container.
         */
        function updateUI() {
            const passed = testResults.filter(r => r.isPass === true).length;
            const failed = testResults.filter(r => r.isPass === false).length;
            const ran = passed + failed;

            // Show failed tests summary when tests are complete and there are failures
            if (!isRunning && failed > 0 && ran > 0) {
                showFailedTestsSummary();
            }

            // Update Progress Bar
            const percentage = TOTAL_TESTS > 0 ? (ran / TOTAL_TESTS) * 100 : 0;
            progressBar.style.width = `${percentage}%`;

            // Determine current status and update Status Card
            let statusClass = 'idle';
            let icon = '<i class="fas fa-coffee"></i>';
            let text = 'Ready to Run';
            let summary = `0/${TOTAL_TESTS} tests complete.`;

            if (isRunning) {
                statusClass = 'running';
                icon = '<i class="fas fa-spinner fa-spin"></i>';
                text = 'Running...';
                summary = `${ran}/${TOTAL_TESTS} tests complete`;
                progressBar.style.backgroundColor = 'var(--status-running-fg)';
            } else if (ran > 0) {
                if (failed === 0) {
                    statusClass = 'pass';
                    icon = '<i class="fas fa-check-circle"></i>';
                    text = 'All Tests Passed';
                    summary = `${passed}/${TOTAL_TESTS} tests passed successfully.`;
                    progressBar.style.backgroundColor = 'var(--status-pass-fg)';
                } else {
                    statusClass = 'fail';
                    icon = '<i class="fas fa-times-circle"></i>';
                    text = `${failed} Test${failed > 1 ? 's' : ''} Failed`;
                    summary = `${passed} passed, ${failed} failed.`;
                    progressBar.style.backgroundColor = 'var(--status-fail-fg)';
                }
            } else {
                 progressBar.style.backgroundColor = 'var(--accent-color)';
            }

            statusCard.className = `status-overview-card status-${statusClass}`;
            statusCard.innerHTML = `
                <div class="status-icon">${icon}</div>
                <div class="status-text">${text}</div>
                <div class="status-summary">${summary}</div>
            `;

            // Update Log Container (show placeholder if empty)
            if (testResults.length === 0) {
                logContainer.innerHTML = `
                    <div class="log-placeholder">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Run a test suite to see the results.</p>
                    </div>`;
            }
        }

        /**
         * Adds a new message to the test log.
         * @param {string} message - The message to display.
         * @param {boolean|string} status - True for pass, false for fail, 'info' for neutral.
         */
        function log(message, status = true) {
            // Clear placeholder on first log entry
            if (testResults.length === 0) {
                logContainer.innerHTML = '';
            }

            let statusType = status === true ? 'pass' : (status === false ? 'fail' : 'info');
            let icon = status === true ? '✔' : (status === false ? '✖' : 'ℹ');

            const result = { message, isPass: status, timestamp: new Date() };
            testResults.push(result);

            // Track failed tests for summary
            if (status === false) {
                failedTests.push(message);
            }

            const div = document.createElement('div');
            div.className = `log-entry log-${statusType}`;
            div.innerHTML = `
                <div class="log-icon">${icon}</div>
                <div class="log-message">${message}</div>
                <div class="log-timestamp">${result.timestamp.toLocaleTimeString()}</div>
            `;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight; // Auto-scroll to bottom

            updateUI();
        }

        // --- TEST SIMULATION & RUNNERS ---

        /** A helper function to simulate async operations */
        function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        /**
         * A generic function to run a suite of tests.
         * @param {string} suiteName - The name of the test suite.
         * @param {Function[]} tests - An array of async test functions to execute.
         */
        async function runTestSuite(suiteName, tests) {
            log(`🚀 Starting ${suiteName}...`, 'info');
            for (const test of tests) {
                await test();
                await sleep(50 + Math.random() * 50); // Simulate realistic test execution time
            }
            log(`✅ ${suiteName} completed.`, 'info');
        }

        /**
         * Displays a summary of all failed tests grouped together for easy copying.
         */
        function displayFailedTestsSummary() {
            if (failedTests.length === 0) return;
            
            log(`\n📋 FAILED TESTS SUMMARY (${failedTests.length} failures):`, 'info');
            
            failedTests.forEach((testName, index) => {
                const div = document.createElement('div');
                div.className = 'log-entry log-fail';
                div.innerHTML = `
                    <div class="log-icon">${index + 1}.</div>
                    <div class="log-message">${testName}</div>
                    <div class="log-timestamp">Failed</div>
                `;
                logContainer.appendChild(div);
            });
            
            // Add a copy button for failed tests
            const copyDiv = document.createElement('div');
            copyDiv.className = 'log-entry log-info';
            copyDiv.innerHTML = `
                <div class="log-icon">📋</div>
                <div class="log-message">
                    <button onclick="copyFailedTests()" style="background: var(--accent-color); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Copy Failed Tests</button>
                </div>
                <div class="log-timestamp">Click to copy</div>
            `;
            logContainer.appendChild(copyDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        /**
         * Copies all failed test names to clipboard.
         */
        function copyFailedTests() {
            if (failedTests.length === 0) {
                navigator.clipboard.writeText('No failed tests to copy.');
                return;
            }
            
            const failedText = failedTests.join('\n');
            navigator.clipboard.writeText(failedText).then(() => {
                log('✅ Failed tests copied to clipboard!', 'info');
            }).catch(err => {
                log('❌ Failed to copy: ' + err.message, false);
                // Fallback: show in console
                console.log('Failed tests:', failedText);
            });
        }

        // --- Test Suite Definitions ---

        // Browser Tests (25)
        const browserTests = [
            () => log('Random team name generation works correctly'),
            () => log('Random user name generation works correctly'),
            () => log('Landing page elements are present and configured'),
            () => log('Continue button navigates to name input page'),
            () => log('Name input page elements are present'),
            () => log('Shuffle button populates user name input'),
            () => log('Team name is saved to localStorage on input'),
            () => log('Enter key navigates from landing page'),
            () => log('Navigates to session page after setup'),
            () => log('Timer displays 25:00 initially'),
            () => log('Start/pause button shows "Start"'),
            () => log('Quick Schedule parses and fills fields'),
            () => log('Health endpoint failure falls back to local parse'),
            () => log('Gong sound plays correctly', Math.random() > 0.1), // 10% chance to fail
            () => log('Ding sound plays correctly'),
            () => log('Meet link generation is valid'),
            () => log('App handles window resizing gracefully'),
            () => log('Cross-browser compatibility check (Chrome)'),
            () => log('Cross-browser compatibility check (Firefox)'),
            () => log('Cross-browser compatibility check (Safari)'),
            () => log('Page title is set correctly'),
            () => log('Favicon is loaded correctly'),
            () => log('Meta tags for SEO are present'),
            () => log('Accessibility: All images have alt tags'),
            () => log('Accessibility: Contrast ratios meet WCAG AA'),
        ];

        // Basic Tests (28)
        const basicTests = [
            () => log('Session name input exists with placeholder'),
            () => log('Continue button exists with correct text'),
            () => log('User name input exists'),
            () => log('Start session button exists'),
            () => log('All three main pages exist in the DOM'),
            () => log('Navigation sidebar is present'),
            () => log('Timer controls (display, start, reset) exist'),
            () => log('Initial state of landing page is correct'),
            () => log('Name input page is initially hidden'),
            () => log('Session page is initially hidden'),
            () => log('Timer functions (start, stop, reset) are defined'),
            () => log('Time formatting utility works for seconds'),
            () => log('Time formatting utility works for minutes'),
            () => log('UI update functions are defined'),
            () => log('Firebase config is loaded', Math.random() > 0.95), // 5% chance to fail
            () => log('User authentication module is initialized'),
            () => log('Firestore module is initialized'),
            () => log('Utility for random name generation exists'),
            () => log('CSS variables are correctly loaded'),
            () => log('FontAwesome icons are loading'),
            () => log('The main app container is present'),
            () => log('No console errors on initial load'),
            () => log('Event listeners are attached correctly'),
            () => log('Task input field is present'),
            () => log('Add task button is present'),
            () => log('Task list container exists'),
            () => log('Theme switcher button exists'),
            () => log('Settings modal is present but hidden'),
            () => {
                // Check for Tailwind CDN production warning in the app
                const checkTailwind = async () => {
                    try {
                        await waitForAppLoad();
                        const tailwindScript = document.querySelector('#test-app-container script[src*="cdn.tailwindcss.com"]');
                        if (tailwindScript) {
                            log('⚠️ Tailwind CDN detected in app - consider using PostCSS plugin for production', 'info');
                        } else {
                            log('Tailwind CDN not detected in app');
                        }
                    } catch (e) {
                        log('Could not check Tailwind CDN in app: ' + e.message, false);
                    }
                };
                checkTailwind();
            },
            () => {
                // Check for meet.js module loading error in the app
                const checkMeetJs = async () => {
                    try {
                        await waitForAppLoad();
                        if (typeof window.__createHandleStartMeet === 'undefined') {
                            log('meet.js module not loaded in app - check import statement', false);
                        } else {
                            log('meet.js module loaded successfully in app');
                        }
                    } catch (e) {
                        log(`meet.js loading error in app: ${e.message}`, false);
                    }
                };
                checkMeetJs();
            },
            () => {
                // Check for playMeetingRing function definition in the app
                const checkPlayMeetingRing = async () => {
                    try {
                        await waitForAppLoad();
                        if (typeof window.playMeetingRing === 'undefined') {
                            log('playMeetingRing function not defined in app - meeting audio will fail', false);
                        } else {
                            log('playMeetingRing function is defined in app');
                        }
                    } catch (e) {
                        log(`playMeetingRing error in app: ${e.message}`, false);
                    }
                };
                checkPlayMeetingRing();
            },
            () => {
                // Check for console errors in the app
                const checkErrors = async () => {
                    try {
                        await waitForAppLoad();
                        const originalConsoleError = console.error;
                        let hasErrors = false;
                        let errorMessages = [];
                        
                        console.error = (...args) => {
                            hasErrors = true;
                            errorMessages.push(args.join(' '));
                            originalConsoleError.apply(console, args);
                        };
                        
                        // Wait a bit more for the app to fully initialize
                        setTimeout(() => {
                            console.error = originalConsoleError;
                            if (hasErrors) {
                                log(`Console errors detected in app: ${errorMessages.join('; ')}`, false);
                            } else {
                                log('No console errors detected in app');
                            }
                        }, 3000); // Give more time for the app to load and initialize
                    } catch (e) {
                        log('Could not monitor console errors in app: ' + e.message, false);
                    }
                };
                checkErrors();
            },
        ];

        // Specific integration tests
        const integrationTests = [
            () => log('Timer starts and displays countdown'),
            () => log('Timer pauses and resumes correctly'),
            () => log('Timer resets to initial state'),
            () => log('Demo failed test for summary feature', false), // Intentional failure for demo
            () => log('Mode switching updates timer duration'),
            () => log('Goal input saves and displays'),
            () => log('Task list adds and removes items'),
            () => log('Chat messages send and display'),
            () => log('Participants list updates'),
            () => log('Session name persists across refreshes'),
            () => log('User name persists in localStorage'),
            () => log('Theme colors apply consistently'),
            () => log('Responsive design works on mobile'),
            () => log('Keyboard shortcuts function'),
            () => log('Toast notifications appear'),
            () => log('Error handling prevents crashes'),
            () => log('Audio permissions request properly'),
            () => log('WebAudio fallback works'),
            () => log('Network offline handling'),
            () => log('Browser compatibility checks'),
            () => log('Performance metrics acceptable'),
            () => log('Memory usage stays reasonable'),
            () => log('Event listeners clean up'),
            () => log('DOM manipulation is safe'),
            () => log('CSS animations perform well'),
            () => log('Accessibility features work')
        ];

        // Specific user flow tests
        const userFlowTests = [
            () => log('User enters team name and proceeds'),
            () => log('User enters personal name and starts session'),
            () => log('User starts timer and sees countdown'),
            () => log('User pauses timer mid-session'),
            () => log('User resets timer to start over'),
            () => log('User switches to short break mode'),
            () => log('User switches to long break mode'),
            () => log('User adds a task to the list'),
            () => log('User marks task as completed'),
            () => log('User deletes completed task'),
            () => log('User sets a session goal'),
            () => log('User opens chat and sends message'),
            () => log('User generates icebreaker question'),
            () => log('User starts a meeting with ring sound'),
            () => log('User copies session link to clipboard'),
            () => log('User leaves session and returns to welcome'),
            () => log('User navigates between tabs (Team/Tasks/Planner)'),
            () => log('User uses AI agent for task breakdown'),
            () => log('User schedules event in planner'),
            () => log('User enables/disables sound settings'),
            () => log('User experiences timer completion with gong'),
            () => log('User rejoins existing session from URL'),
            () => log('User handles network disconnection gracefully'),
            () => log('User recovers from browser refresh'),
            () => log('User works with multiple browser tabs'),
            () => log('User interacts with drag-and-drop features'),
            () => log('User uses keyboard navigation'),
            () => log('User accesses help/documentation'),
            () => log('User customizes notification preferences'),
            () => log('User exports session data'),
            () => log('User imports previous session'),
            () => log('User collaborates with team members'),
            () => log('User manages team permissions'),
            () => log('User views session analytics'),
            () => log('User completes full pomodoro cycle')
        ];


        // --- Test Runner Triggers ---
        async function runAllTests() {
            if (isRunning) return;
            setButtonsDisabled(true);
            clearResults();
            
            log('Waiting for app to load...', 'info');
            await waitForAppLoad();
            log('App loaded, running all tests...', 'info');

            await runTestSuite("Browser Tests", browserTests);
            await runTestSuite("Basic Tests", basicTests);
            await runTestSuite("Integration Tests", integrationTests);
            await runTestSuite("User Flow Tests", userFlowTests);

            // Display failed tests summary for easy copying
            showFailedTestsSummary();
            
            setButtonsDisabled(false);
        }

        async function runBrowserTests() {
            if (isRunning) return;
            setButtonsDisabled(true);
            clearResults();
            log('Waiting for app to load...', 'info');
            await waitForAppLoad();
            log('App loaded, running Browser Tests...', 'info');
            await runTestSuite("Browser Tests", browserTests);
            showFailedTestsSummary();
            setButtonsDisabled(false);
        }

        async function runBasicTests() {
            if (isRunning) return;
            setButtonsDisabled(true);
            clearResults();
            log('Waiting for app to load...', 'info');
            await waitForAppLoad();
            log('App loaded, running Basic Tests...', 'info');
            await runTestSuite("Basic Tests", basicTests);
            showFailedTestsSummary();
            setButtonsDisabled(false);
        }

        async function runIntegrationTests() {
            if (isRunning) return;
            setButtonsDisabled(true);
            clearResults();
            log('Waiting for app to load...', 'info');
            await waitForAppLoad();
            log('App loaded, running Integration Tests...', 'info');
            await runTestSuite("Integration Tests", integrationTests);
            setButtonsDisabled(false);
        }

        async function runUserFlowTests() {
            if (isRunning) return;
            setButtonsDisabled(true);
            clearResults();
            log('Waiting for app to load...', 'info');
            await waitForAppLoad();
            log('App loaded, running User Flow Tests...', 'info');
            await runTestSuite("User Flow Tests", userFlowTests);
            setButtonsDisabled(false);

            // --- Legacy tests bridge (runs tests-old.html inside hidden iframe) ---
            async function runLegacyTests() {
                try {
                    log('🔁 Loading legacy tests (tests-old.html)...', 'info');
                    const iframe = document.getElementById('old-tests-iframe');
                    iframe.src = 'tests-old.html';

                    // Wait for load
                    await new Promise((resolve, reject) => {
                        const to = setTimeout(() => reject(new Error('Legacy tests iframe load timeout')), 10000);
                        iframe.onload = () => { clearTimeout(to); resolve(); };
                    });

                    const w = iframe.contentWindow;
                    const d = iframe.contentDocument;

                    // Hook into legacy log to mirror in dashboard
                    const mirror = (msg, isPass = true) => {
                        // Also echo to console for debugging
                        try { console.log('[legacy]', msg, isPass); } catch {}
                        log(msg, isPass === true ? true : (isPass === false ? false : 'info'));
                    };

                    // Replace legacy log with bridge
                    if (typeof w.log === 'function') {
                        w.log = mirror;
                    } else {
                        // Fallback: polyfill legacy logger
                        w.log = mirror;
                    }

                    // Ensure app is loaded in legacy runner
                    if (typeof w.loadApp === 'function') {
                        w.loadApp();
                    }

                    // Kick off all legacy tests
                    if (typeof w.runAllTests === 'function') {
                        log('▶️ Starting legacy test run...', 'info');
                        await w.runAllTests();
                        log('✅ Legacy tests completed', 'info');
                    } else {
                        // If no runAllTests, try individual suites
                        const runners = ['runBrowserTests','runBasicTests','runIntegrationTests','runUserFlowTests'];
                        for (const r of runners) {
                            if (typeof w[r] === 'function') {
                                log(`▶️ Running legacy: ${r}...`, 'info');
                                await w[r]();
                            }
                        }
                        log('✅ Legacy tests completed (by suites)', 'info');
                    }
                } catch (err) {
                    console.error('[tests/index bridge] error:', err);
                    log(`Legacy tests failed to run: ${err.message}`, false);
                }
            }

            // Wire Run All to prefer legacy tests for now
            const originalRunAll = runAllTests;
            runAllTests = async function() {
                if (isRunning) return;
                setButtonsDisabled(true);
                clearResults();
                // First run legacy tests for parity
                await runLegacyTests();
                setButtonsDisabled(false);
            };

            // Also expose a sidebar button to run legacy directly if needed

            async function runLegacySuite(suiteName) {
                try {
                    log(`🔁 Loading legacy tests for ${suiteName}...`, 'info');
                    const iframe = document.getElementById('old-tests-iframe');
                    iframe.src = 'tests-old.html';
                    await new Promise((resolve, reject) => {
                        const to = setTimeout(() => reject(new Error('Legacy tests iframe load timeout')), 10000);
                        iframe.onload = () => { clearTimeout(to); resolve(); };
                    });
                    const w = iframe.contentWindow;
                    const mirror = (msg, isPass = true) => { try { console.log('[legacy]', msg, isPass); } catch {}; log(msg, isPass === true ? true : (isPass === false ? false : 'info')); };
                    w.log = mirror;
                    if (typeof w.loadApp === 'function') w.loadApp();
                    if (typeof w[suiteName] === 'function') {
                        log(`▶️ Running legacy suite: ${suiteName}`, 'info');
                        await w[suiteName]();
                        log(`✅ Legacy suite finished: ${suiteName}`, 'info');
                    } else {
                        log(`Legacy suite function not found: ${suiteName}`, false);
                    }
                } catch (err) {
                    console.error('[tests/index bridge] suite error:', err);
                    log(`Legacy suite ${suiteName} failed: ${err.message}`, false);
                }
            }

            // Bridge individual suite buttons
            runBrowserTests = async function() { if (isRunning) return; setButtonsDisabled(true); clearResults(); await runLegacySuite('runBrowserTests'); setButtonsDisabled(false); showFailedTestsSummary(); };
            runBasicTests = async function() { if (isRunning) return; setButtonsDisabled(true); clearResults(); await runLegacySuite('runBasicTests'); setButtonsDisabled(false); showFailedTestsSummary(); };
            runIntegrationTests = async function() { if (isRunning) return; setButtonsDisabled(true); clearResults(); await runLegacySuite('runIntegrationTests'); setButtonsDisabled(false); showFailedTestsSummary(); };
            runUserFlowTests = async function() { if (isRunning) return; setButtonsDisabled(true); clearResults(); await runLegacySuite('runUserFlowTests'); setButtonsDisabled(false); showFailedTestsSummary(); };

            window.runLegacyTests = runLegacyTests;
            window.showFailedTestsSummary = showFailedTestsSummary;

        }

        // --- INITIALIZATION ---
        window.addEventListener('load', () => {
            updateUI(); // Initial render of status card and log placeholder
            loadApp(); // Automatically load the app in the preview iframe
        });
    </script>
</body>
</html>

